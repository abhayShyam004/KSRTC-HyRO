<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSRTC-HyRO Admin | Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-link:hover { background: #eff6ff; border-left-color: #3b82f6; color: #1d4ed8; }
        .sidebar-link.active { background: #eff6ff; border-left-color: #3b82f6; color: #1d4ed8; font-weight: 600; }
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15); }
        .table-row:hover { background: #f8fafc; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .stop-badge { display: inline-block; font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: 600; }
        .stop-badge.airport { background: #f3e8ff; color: #7c3aed; }
        .stop-badge.high-demand { background: #ffedd5; color: #ea580c; }
        .stop-badge.commercial { background: #dbeafe; color: #2563eb; }
        /* Map Picker Styles */
        #pickerMap { z-index: 1;cursor: crosshair; }
        .leaflet-container { font-family: 'Inter', sans-serif !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex">

    <!-- ========== SIDEBAR ========== -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col fixed h-full z-50 shadow-sm">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-200">
                    <i class="ph ph-bus text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-gray-900">KSRTC-HyRO</h1>
                    <p class="text-[10px] text-blue-600 font-semibold uppercase tracking-wider">Admin Panel</p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-1">
            <a href="#" onclick="showSection('dashboard')" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-600" id="nav-dashboard">
                <i class="ph ph-chart-pie-slice text-xl text-blue-500"></i> Dashboard
            </a>
            <a href="#" onclick="showSection('stops')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-600" id="nav-stops">
                <i class="ph ph-map-pin text-xl text-gray-400"></i> Manage Stops
            </a>
            <a href="#" onclick="showSection('settings')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-600" id="nav-settings">
                <i class="ph ph-gear-six text-xl text-gray-400"></i> Configuration
            </a>
            <a href="#" onclick="showSection('users')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-sm text-gray-600" id="nav-users">
                <i class="ph ph-users-three text-xl text-gray-400"></i> User Management
            </a>
        </nav>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-100 space-y-2">
            <a href="/" class="flex items-center gap-2 px-4 py-2.5 text-sm text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">
                <i class="ph ph-arrow-left text-lg"></i> Back to App
            </a>
            <button onclick="logout()" class="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-red-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition">
                <i class="ph ph-sign-out text-lg"></i> Logout
            </button>
        </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="flex-1 ml-64 p-8">
        
        <!-- HEADER -->
        <header class="flex items-center justify-between mb-8">
            <div>
                <h2 class="text-2xl font-bold text-gray-900" id="sectionTitle">Analytics Dashboard</h2>
                <p class="text-gray-500 text-sm mt-1">Real-time insights into your fleet operations</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- Status Indicator -->
                <div id="dbStatusBadge" class="hidden px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-2 bg-gray-100 text-gray-500 border border-gray-200" title="Checking database connection...">
                    <span class="w-2 h-2 rounded-full bg-gray-400 animate-pulse"></span>
                    <span id="dbStatusText">Checking...</span>
                </div>
                

            </div>
        </header>

        <!-- ========== DASHBOARD SECTION ========== -->
        <section id="section-dashboard" class="fade-in">
            <!-- Stats Grid -->
            <div class="grid grid-cols-4 gap-6 mb-8">
                <div class="stat-card bg-slate-50 rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="h-12 w-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="ph ph-users text-2xl text-blue-600"></i>
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900" id="totalPassengers">--</p>
                    <p class="text-gray-500 text-sm mt-1">Total Passengers</p>
                </div>
                <div class="stat-card bg-slate-50 rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="h-12 w-12 bg-emerald-100 rounded-xl flex items-center justify-center">
                            <i class="ph ph-path text-2xl text-emerald-600"></i>
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900" id="totalRoutes">--</p>
                    <p class="text-gray-500 text-sm mt-1">Routes Optimized</p>
                </div>
                <div class="stat-card bg-slate-50 rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="h-12 w-12 bg-orange-100 rounded-xl flex items-center justify-center">
                            <i class="ph ph-gas-pump text-2xl text-orange-600"></i>
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900" id="fuelSaved">--</p>
                    <p class="text-gray-500 text-sm mt-1">Est. Fuel Saved</p>
                </div>
                <div class="stat-card bg-slate-50 rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="h-12 w-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="ph ph-map-pin text-2xl text-purple-600"></i>
                        </div>
                    </div>
                    <p class="text-3xl font-bold text-gray-900" id="activeStops">--</p>
                    <p class="text-gray-500 text-sm mt-1">Active Stops</p>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 gap-6 mb-8">
                <!-- Passenger Trends Chart -->
                <div class="bg-slate-50 rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-lg text-gray-900">Route Optimization Activity</h3>
                            <p class="text-gray-500 text-sm">Routes optimized over the last 7 days</p>
                        </div>
                    </div>
                    <canvas id="passengerChart" height="80"></canvas>
                </div>
            </div>
        </section>

        <!-- ========== MANAGE STOPS SECTION ========== -->
        <section id="section-stops" class="hidden fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <p class="text-gray-500 text-sm">Add, edit, or remove bus stops from the network</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <input type="text" id="stopsSearchInput" onkeyup="filterStopsTable()" placeholder="Search stops..." class="bg-white border border-gray-200 rounded-xl px-4 py-2.5 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 shadow-sm">
                        <i class="ph ph-magnifying-glass absolute left-3.5 top-3 text-gray-400"></i>
                    </div>
                    <button onclick="openAddStopModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition flex items-center gap-2 shadow-lg shadow-blue-200">
                        <i class="ph ph-plus-circle text-lg"></i> Add New Stop
                    </button>
                </div>
            </div>

            <div class="bg-slate-50 rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-500 text-xs uppercase tracking-wider border-b border-gray-100 bg-gray-50">
                            <th class="px-6 py-4">ID</th>
                            <th class="px-6 py-4">Stop Name</th>
                            <th class="px-6 py-4">District</th>
                            <th class="px-6 py-4">Category</th>
                            <th class="px-6 py-4">Demand Multiplier</th>
                            <th class="px-6 py-4">Coordinates</th>
                            <th class="px-6 py-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stopsTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ========== CONFIGURATION SECTION ========== -->
        <section id="section-settings" class="hidden fade-in">
            <!-- Header with Actions -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <p class="text-gray-500 text-sm">Configure system parameters and defaults</p>
                </div>
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition flex items-center gap-2 shadow-lg shadow-blue-200">
                    <i class="ph ph-floppy-disk text-lg"></i> Save Changes
                </button>
            </div>

            <div class="flex flex-col gap-6">
                <!-- Fuel Settings -->
                <div class="bg-slate-50 rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="h-10 w-10 bg-orange-100 rounded-xl flex items-center justify-center">
                            <i class="ph ph-gas-pump text-xl text-orange-600"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900">Fuel Configuration</h3>
                            <p class="text-gray-500 text-sm">Manage fuel cost calculations</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm text-gray-600 font-medium mb-2">Diesel Price (₹/litre)</label>
                            <input type="number" id="dieselPrice" value="95.21" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 font-medium mb-2">Empty Bus Mileage (km/L)</label>
                            <input type="number" id="emptyMileage" value="4.5" step="0.1" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 font-medium mb-2">Full Bus Mileage (km/L)</label>
                            <input type="number" id="fullMileage" value="3.5" step="0.1" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Bus Settings -->
                <div class="bg-slate-50 rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="h-10 w-10 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="ph ph-bus text-xl text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900">Bus Configuration</h3>
                            <p class="text-gray-500 text-sm">Standard bus parameters</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm text-gray-600 font-medium mb-2">Bus Seating Capacity</label>
                            <input type="number" id="busCapacity" value="55" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <!-- ML Model Management -->
                 <div class="bg-slate-50 rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="h-10 w-10 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="ph ph-brain text-xl text-purple-600"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900">AI Model Management</h3>
                            <p class="text-gray-500 text-sm">Self-learning system controls</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                         <div class="text-sm text-gray-600">
                            <p>Current Model: <span class="font-semibold text-gray-900">Passenger Demand Predictor v1.0</span></p>
                            <p class="text-xs text-gray-500 mt-1">Learns from 'demand_history' table automatically.</p>
                        </div>
                        <button onclick="retrainModel()" id="retrainBtn" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-xl text-sm font-medium transition flex items-center gap-2">
                            <i class="ph ph-arrows-clockwise"></i> Retrain Model Now
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== USER MANAGEMENT SECTION ========== -->
        <section id="section-users" class="hidden fade-in space-y-8">
            <!-- 1. Admins Section -->
            <div>
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Administrators</h3>
                        <p class="text-gray-500 text-sm">Manage system access and permissions</p>
                    </div>
                    <button onclick="openAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition flex items-center gap-2 shadow-lg shadow-blue-200">
                        <i class="ph ph-user-plus text-lg"></i> Add New Admin
                    </button>
                </div>
    
                <div class="bg-slate-50 rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-500 text-xs uppercase tracking-wider border-b border-gray-100 bg-gray-50">
                                <th class="px-6 py-4">User</th>
                                <th class="px-6 py-4">Email</th>
                                <th class="px-6 py-4">Role</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4">Joined</th>
                                <th class="px-6 py-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. Drivers Section -->
            <div>
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Drivers</h3>
                        <p class="text-gray-500 text-sm">Manage bus drivers and assignments</p>
                    </div>
                    <button disabled class="bg-gray-100 text-gray-400 px-5 py-2.5 rounded-xl text-sm font-semibold cursor-not-allowed flex items-center gap-2">
                        <i class="ph ph-steering-wheel text-lg"></i> Add New Driver
                    </button>
                </div>
    
                <div class="bg-slate-50 rounded-2xl border border-gray-200 shadow-sm p-12 flex flex-col items-center justify-center text-center border-dashed">
                    <div class="h-16 w-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="ph ph-steering-wheel text-3xl text-gray-400"></i>
                    </div>
                    <h4 class="text-gray-900 font-medium mb-1">Driver Management</h4>
                    <p class="text-gray-500 text-sm max-w-md">This module is currently under development. You will be able to manage driver profiles, schedules, and assignments here soon.</p>
                </div>
            </div>
        </section>

    </main>

    <!-- ========== ADD STOP MODAL ========== -->
    <div id="addStopModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-4xl border border-gray-200 shadow-2xl flex flex-col max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900" id="modalTitle">Add New Stop</h3>
                <button onclick="closeAddStopModal()" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="editStopId">
                <div>
                    <label class="block text-sm text-gray-600 font-medium mb-2">Stop Name</label>
                    <input type="text" id="newStopName" placeholder="e.g., Ernakulam Central" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 font-medium mb-2">Latitude</label>
                        <input type="number" id="newStopLat" step="0.0001" placeholder="Click on map or type" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 font-medium mb-2">Longitude</label>
                        <input type="number" id="newStopLon" step="0.0001" placeholder="Click on map or type" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <!-- Map Picker Container -->
                <div class="rounded-xl overflow-hidden border border-gray-200 shadow-sm relative">
                    <div id="pickerMap" class="h-96 w-full bg-slate-100"></div>
                     <div class="absolute bottom-2 left-2 bg-white/90 px-2 py-1 rounded text-[10px] text-gray-500 shadow z-[500]">Click to select location</div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 font-medium mb-2">District</label>
                    <select id="newStopDistrict" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option>Thiruvananthapuram</option>
                        <option>Kollam</option>
                        <option>Alappuzha</option>
                        <option selected>Ernakulam</option>
                        <option>Kottayam</option>
                        <option>Thrissur</option>
                        <option>Palakkad</option>
                        <option>Malappuram</option>
                        <option>Kozhikode</option>
                        <option>Wayanad</option>
                        <option>Kannur</option>
                        <option>Kasargod</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 font-medium mb-2">Category</label>
                        <select id="newStopCategory" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="regular">Regular</option>
                            <option value="transport_hub">Transport Hub</option>
                            <option value="airport">Airport</option>
                            <option value="commercial">Commercial</option>
                            <option value="tourist">Tourist</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddStopModal()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition">Cancel</button>
                <button onclick="saveStop()" id="modalActionBtn" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition shadow-lg shadow-blue-200">Add Stop</button>
            </div>
        </div>
    </div>

    <!-- ========== TOAST ========== -->
    <div id="toast" class="fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-4 rounded-xl shadow-xl flex items-center gap-3 transform translate-y-20 opacity-0 transition-all duration-300">
        <i class="ph ph-check-circle text-xl"></i>
        <span id="toastMessage">Settings saved successfully!</span>
    </div>

    <script>
        let busStops = [];
        
        // ========== AUTHENTICATION ==========
        const token = localStorage.getItem('admin_token');
        
        // Check authentication on page load
        if (!token) {
            window.location.href = '/login.html';
        } else {
            // Verify token is still valid
            fetch('/api/auth/verify', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => res.json())
            .then(data => {
                if (!data.valid) {
                    localStorage.removeItem('admin_token');
                    window.location.href = '/login.html';
                }
            })
            .catch(() => {
                localStorage.removeItem('admin_token');
                window.location.href = '/login.html';
            });
        }
        
        // Helper function for authenticated API requests
        async function apiRequest(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token,
                ...options.headers
            };
            
            const response = await fetch(url, { ...options, headers });
            
            if (response.status === 401) {
                localStorage.removeItem('admin_token');
                window.location.href = '/login.html';
                throw new Error('Unauthorized');
            }
            
            return response;
        }
        
        // Logout function
        function logout() {
            fetch('/api/auth/logout', { method: 'POST' });
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/login.html';
        }

        // Load bus stops from API
        async function loadStops() {
            try {
                const response = await apiRequest('/api/stops');
                busStops = await response.json();
                renderStopsTable();
                document.getElementById('activeStops').textContent = busStops.length;
            } catch (e) {
                console.error('Failed to load stops:', e);
                // Fallback to JSON file
                try {
                    const res = await fetch('/bus_stops.json?t=' + Date.now());
                    busStops = await res.json();
                    renderStopsTable();
                    document.getElementById('activeStops').textContent = busStops.length;
                } catch (e2) {
                    console.error('Fallback failed:', e2);
                }
            }
        }

        // Render stops table
        function renderStopsTable() {
            const tbody = document.getElementById('stopsTableBody');
            if (!busStops.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No stops found.</td></tr>';
                return;
            }
            
            // 1. Sort by District then Name
            const sortedStops = [...busStops].sort((a, b) => {
                const distA = a.district || "";
                const distB = b.district || "";
                if (distA === distB) return a.name.localeCompare(b.name);
                return distA.localeCompare(distB);
            });

            let currentDistrict = '';
            let html = '';
            let globalIndex = 1;

            sortedStops.forEach((stop, index) => {
                // District Header
                if (stop.district !== currentDistrict) {
                    currentDistrict = stop.district || "Uncategorized";
                    html += `
                        <tr class="district-header bg-slate-50/50 border-b border-gray-100">
                            <td colspan="7" class="px-6 py-1.5 text-[11px] font-semibold text-gray-400 bg-gray-50/50">
                                ${currentDistrict}
                            </td>
                        </tr>
                    `;
                }

                const categoryBadge = getCategoryBadge(stop.category);
                
                html += `
                    <tr class="table-row border-b border-gray-50 stop-row">
                        <td class="px-6 py-4 text-gray-900 font-medium text-sm">
                            ${globalIndex++}
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900 stop-name">${stop.name}</td>
                        <td class="px-6 py-4 text-gray-500">${stop.district}</td>
                        <td class="px-6 py-4">${categoryBadge}</td>
                        <td class="px-6 py-4">
                            <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-xs font-mono font-semibold">${stop.demand_multiplier || 1.0}x</span>
                        </td>
                        <td class="px-6 py-4 text-gray-400 text-xs font-mono">${stop.lat.toFixed(4)}, ${stop.lon.toFixed(4)}</td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="editStop(${stop.bus_stop_id})" class="p-2 hover:bg-gray-100 rounded-lg transition"><i class="ph ph-pencil text-gray-500"></i></button>
                                <button onclick="deleteStop(${stop.bus_stop_id})" class="p-2 hover:bg-red-50 rounded-lg transition"><i class="ph ph-trash text-red-500"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function getCategoryBadge(category) {
            const badges = {
                'transport_hub': '<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-xs font-semibold">Transport Hub</span>',
                'airport': '<span class="bg-purple-100 text-purple-600 px-2 py-1 rounded-full text-xs font-semibold">Airport</span>',
                'commercial': '<span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-xs font-semibold">Commercial</span>',
                'tourist': '<span class="bg-emerald-100 text-emerald-600 px-2 py-1 rounded-full text-xs font-semibold">Tourist</span>',
                'regular': '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs font-semibold">Regular</span>'
            };
            return badges[category] || badges['regular'];
        }

        // Section Navigation
        // Section Navigation
        function showSection(section) {
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('section-' + section);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-link').forEach(el => {
                el.classList.remove('active');
                el.querySelector('i').classList.remove('text-blue-500');
                el.querySelector('i').classList.add('text-gray-400');
            });
            const activeLink = document.getElementById('nav-' + section);
            if(activeLink) {
                activeLink.classList.add('active');
                activeLink.querySelector('i').classList.remove('text-gray-400');
                activeLink.querySelector('i').classList.add('text-blue-500');
            }
            
            const titles = { dashboard: 'Analytics Dashboard', stops: 'Manage Bus Stops', settings: 'System Configuration', users: 'User Management' };
            document.getElementById('sectionTitle').textContent = titles[section] || 'KSRTC-HyRO Admin';
            
            // Persist state
            localStorage.setItem('admin_last_section', section);
        }

        // Modals & Map Picker
        let pickerMap = null;
        let pickerMarker = null;


        function openAddStopModal(editId = null) { 
            const modal = document.getElementById('addStopModal');
            const title = document.getElementById('modalTitle');
            const btn = document.getElementById('modalActionBtn');
            const editInput = document.getElementById('editStopId');
            
            modal.classList.remove('hidden'); 
            modal.classList.add('flex'); 
            
            // Initialize map after short delay
            setTimeout(() => {
                initPickerMap();
                
                // If editing, populate fields
                if (editId) {
                    const stop = busStops.find(s => s.bus_stop_id === editId);
                    if (stop) {
                        document.getElementById('newStopName').value = stop.name;
                        document.getElementById('newStopLat').value = stop.lat;
                        document.getElementById('newStopLon').value = stop.lon;
                        document.getElementById('newStopDistrict').value = stop.district || 'Ernakulam';
                        document.getElementById('newStopCategory').value = stop.category || 'regular';
                        editInput.value = editId;
                        
                        title.textContent = 'Edit Stop';
                        btn.textContent = 'Update Stop';
                        
                        // Update marker
                        if(pickerMap) {
                            pickerMap.setView([stop.lat, stop.lon], 14);
                             if (pickerMarker) {
                                pickerMarker.setLatLng([stop.lat, stop.lon]);
                            } else {
                                pickerMarker = L.marker([stop.lat, stop.lon]).addTo(pickerMap);
                            }
                        }
                    }
                } else {
                    // Reset for adding
                    document.getElementById('newStopName').value = '';
                    document.getElementById('newStopLat').value = '';
                    document.getElementById('newStopLon').value = '';
                    editInput.value = '';
                    title.textContent = 'Add New Stop';
                    btn.textContent = 'Add Stop';
                    if(pickerMarker) pickerMarker.remove();
                    pickerMarker = null;
                    if(pickerMap) pickerMap.setView([9.9816, 76.2999], 10);
                }
            }, 200);
        }

        function initPickerMap() {
            if (pickerMap) {
                pickerMap.invalidateSize();
                return;
            }
            
            // Default center: Ernakulam (approx)
            pickerMap = L.map('pickerMap').setView([9.9816, 76.2999], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(pickerMap);
            
            // Add click handler
            pickerMap.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(5);
                const lon = e.latlng.lng.toFixed(5);
                
                // Update inputs
                document.getElementById('newStopLat').value = lat;
                document.getElementById('newStopLon').value = lon;
                
                // Update or add marker
                if (pickerMarker) {
                    pickerMarker.setLatLng(e.latlng);
                } else {
                    pickerMarker = L.marker(e.latlng).addTo(pickerMap);
                }
            });
        }

        function closeAddStopModal() { 
            document.getElementById('addStopModal').classList.add('hidden'); 
            document.getElementById('addStopModal').classList.remove('flex'); 
        }

        // Toast
        
        function filterStopsTable() {
            const input = document.getElementById('stopsSearchInput');
            const filter = input.value.toUpperCase();
            const tableBody = document.getElementById("stopsTableBody");
            const rows = tableBody.getElementsByTagName("tr");
            
            let currentHeader = null;
            let hasVisibleChildren = false;

            // Pass 1: Filter Stops
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                if (row.classList.contains('district-header')) {
                    // New section starting
                    // If we had a previous header, we decide its visibility based on children (handled dynamically below? no need)
                    // We just reset for the new section
                    currentHeader = row;
                    hasVisibleChildren = false;
                    
                    // Initially hide header, we reveal it if we find a visible child
                    row.style.display = "none"; 
                } else if (row.classList.contains('stop-row')) {
                    const nameCell = row.querySelector('.stop-name');
                    const txtValue = nameCell ? (nameCell.textContent || nameCell.innerText) : "";
                    
                    const isMatch = txtValue.toUpperCase().indexOf(filter) > -1;
                    
                    if (isMatch) {
                        row.style.display = "";
                        // Since this child is visible, its header must be visible
                        if (currentHeader) currentHeader.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }
            }
        }
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function saveSettings() { showToast('Settings saved successfully!'); }
        function toggleStopEdit(id) { editStop(id); } // Alias
        function editStop(id) {
            openAddStopModal(id);
        }

        async function saveStop() {
            const id = document.getElementById('editStopId').value;
            const name = document.getElementById('newStopName').value.trim();
            const lat = document.getElementById('newStopLat').value;
            const lon = document.getElementById('newStopLon').value;
            const district = document.getElementById('newStopDistrict').value;
            const category = document.getElementById('newStopCategory').value;

            if (!name || !lat || !lon || !district) {
                return alert('Please fill in all required fields (Name, Latitude, Longitude, District)');
            }

            try {
                const url = id ? `/api/stops/${id}` : '/api/stops';
                const method = id ? 'PUT' : 'POST';
                
                const response = await apiRequest(url, {
                    method: method,
                    body: JSON.stringify({
                        name,
                        lat: parseFloat(lat),
                        lon: parseFloat(lon),
                        district,
                        category
                    })
                });

                if (response.ok) {
                    showToast('Stop "' + name + '" ' + (id ? 'updated' : 'added') + ' successfully!');
                    closeAddStopModal();
                    loadStops(); // Refresh list
                    // Clear inputs handled by open logic
                } else {
                    const data = await response.json();
                    alert('Error saving stop: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to connect to server');
            }
        }
        async function deleteStop(id) {
            if (confirm('Are you sure you want to delete this stop?')) {
                try {
                    const response = await apiRequest('/api/stops/' + id, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showToast('Stop deleted successfully!');
                        loadStops(); // Refresh list
                    } else {
                        const data = await response.json();
                        alert('Error deleting stop: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete stop');
                }
            }
        }

        // Global Chart Instance
        let chartInstance = null;

        // Load analytics from API
        async function loadAnalytics() {
            try {
                const response = await apiRequest('/api/analytics');
                const data = await response.json();
                
                // Update stat cards
                document.getElementById('totalPassengers').textContent = data.total_passengers.toLocaleString();
                document.getElementById('totalRoutes').textContent = data.routes_optimized.toLocaleString();
                document.getElementById('fuelSaved').textContent = '₹' + (data.fuel_saved / 1000).toFixed(1) + 'K';
                document.getElementById('activeStops').textContent = data.active_stops;

                // Update Chart
                if (chartInstance && data.trends) {
                    processChartData(data.trends);
                }
                
            } catch (e) {
                console.log('Analytics not available:', e);
                // Set to zeros if API fails
                document.getElementById('totalPassengers').textContent = '0';
                document.getElementById('totalRoutes').textContent = '0';
                document.getElementById('fuelSaved').textContent = '₹0';
            }
        }

        async function retrainModel() {
            const btn = document.getElementById('retrainBtn');
            const icon = btn.querySelector('i');
            
            // Loading state
            btn.disabled = true;
            icon.classList.add('animate-spin');
            btn.classList.add('opacity-75');
            
            try {
                const response = await apiRequest('/api/admin/retrain', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Success: ' + data.message);
                } else {
                    alert('Training failed: ' + data.error);
                }
            } catch (e) {
                console.error(e);
                alert('Failed to connect for retraining.');
            } finally {
                // Reset state
                btn.disabled = false;
                icon.classList.remove('animate-spin');
                btn.classList.remove('opacity-75');
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                const response = await apiRequest('/api/users');
                const users = await response.json();
                const tbody = document.getElementById('adminsTableBody');
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No administrators found.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(user => {
                    const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    const roleBadge = user.role === 'super_admin' 
                        ? '<span class="bg-purple-100 text-purple-600 px-3 py-1 rounded-full text-xs font-semibold">Super Admin</span>'
                        : '<span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-semibold">Operator</span>';
                    
                    const statusBadge = user.status === 'active'
                        ? '<span class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-xs font-semibold">Active</span>'
                        : '<span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-semibold">Inactive</span>';
                        
                    return `
                        <tr class="table-row border-b border-gray-50">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="h-9 w-9 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-sm font-bold text-white">${initials}</div>
                                    <span class="font-medium text-gray-900">${user.name}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-gray-500">${user.email}</td>
                            <td class="px-6 py-4">${roleBadge}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-gray-500 text-sm">${new Date(user.created_at || Date.now()).toLocaleDateString()}</td>
                            <td class="px-6 py-4">
                                <div class="flex gap-2">
                                    <button class="p-2 hover:bg-gray-100 rounded-lg transition"><i class="ph ph-pencil text-gray-500"></i></button>
                                    <button class="p-2 hover:bg-red-50 rounded-lg transition"><i class="ph ph-trash text-red-500"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (e) {
                console.error("Failed to load users", e);
            }
        }

        function processChartData(trends) {
            // Helper to get last 7 days dates formatted
            const labels = [];
            const dataPoints = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' }); // Mon, Tue
                
                labels.push(dayName);
                
                // Find matching data point
                const dayData = trends.find(t => {
                   // Handle both string date and Date object scenarios from JSON
                   const tDate = t.date.toString().split('T')[0]; 
                   return tDate === dateStr;
                });
                
                dataPoints.push(dayData ? dayData.routes_optimized : 0);
            }
            
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = dataPoints;
            chartInstance.update();
        }

        // Initialize Charts - simple activity chart
        function initCharts() {
            const ctx = document.getElementById('passengerChart');
            if (!ctx) return;
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Routes Optimized',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#3b82f6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8', stepSize: 1 }, 
                            grid: { color: '#f1f5f9' } 
                        },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }

        async function checkDbStatus() {
            try {
                const badge = document.getElementById('dbStatusBadge');
                const text = document.getElementById('dbStatusText');
                const dot = badge.querySelector('span');
                
                badge.classList.remove('hidden');
                
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.status === 'online' && data.db_available) {
                    // Online (Green)
                    badge.className = "px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-2 bg-emerald-50 text-emerald-700 border border-emerald-200";
                    dot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-none";
                    text.innerText = "Cloud DB Online";
                } else {
                    // Offline (Orange)
                    badge.className = "px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-2 bg-orange-50 text-orange-700 border border-orange-200";
                    dot.className = "w-2 h-2 rounded-full bg-orange-500 animate-none";
                    text.innerText = "Offline Mode (Local)";
                }
            } catch (e) {
                console.error("Status check failed", e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkDbStatus(); // Check status on load
            loadStops();
            loadAnalytics();
            loadUsers();
            initCharts();
            
            // Restore last section
            const lastSection = localStorage.getItem('admin_last_section') || 'dashboard';
            showSection(lastSection);
        });
    </script>
</body>
</html>
